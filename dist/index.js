class b extends Error{response;request;options;constructor(e,s,r){const n=e.status||e.status===0?e.status:"",o=e.statusText??"",a=`${n} ${o}`.trim(),c=a?`status code ${a}`:"an unknown error";super(`Request failed with ${c}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=e,this.request=s,this.options=r}}class I extends Error{name="NonError";value;constructor(e){let s="Non-error value was thrown";try{typeof e=="string"?s=e:e&&typeof e=="object"&&"message"in e&&typeof e.message=="string"&&(s=e.message)}catch{}super(s),this.value=e}}class g extends Error{name="ForceRetryError";customDelay;code;customRequest;constructor(e){const s=e?.cause?e.cause instanceof Error?e.cause:new I(e.cause):void 0;super(e?.code?`Forced retry: ${e.code}`:"Forced retry",s?{cause:s}:void 0),this.customDelay=e?.delay,this.code=e?.code,this.customRequest=e?.request}}const q=(()=>{let t=!1,e=!1;const s=typeof globalThis.ReadableStream=="function",r=typeof globalThis.Request=="function";if(s&&r)try{e=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type")}catch(n){if(n instanceof Error&&n.message==="unsupported BodyInit type")return!1;throw n}return t&&!e})(),V=typeof globalThis.AbortController=="function",j=typeof globalThis.AbortSignal=="function"&&typeof globalThis.AbortSignal.any=="function",W=typeof globalThis.ReadableStream=="function",Y=typeof globalThis.FormData=="function",v=["get","post","put","patch","head","delete"],K={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*",bytes:"*/*"},w=2147483647,X=new TextEncoder().encode("------WebKitFormBoundaryaxpyiPgbbPti10Rw").length,N=Symbol("stop");class O{options;constructor(e){this.options=e}}const G=t=>new O(t),Q={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,onUploadProgress:!0,fetch:!0,context:!0},Z={next:!0},ee={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,duplex:!0},te=t=>{if(!t)return 0;if(t instanceof FormData){let e=0;for(const[s,r]of t)e+=X,e+=new TextEncoder().encode(`Content-Disposition: form-data; name="${s}"`).length,e+=typeof r=="string"?new TextEncoder().encode(r).length:r.size;return e}if(t instanceof Blob)return t.size;if(t instanceof ArrayBuffer)return t.byteLength;if(typeof t=="string")return new TextEncoder().encode(t).length;if(t instanceof URLSearchParams)return new TextEncoder().encode(t.toString()).length;if("byteLength"in t)return t.byteLength;if(typeof t=="object"&&t!==null)try{const e=JSON.stringify(t);return new TextEncoder().encode(e).length}catch{return 0}return 0},U=(t,e,s)=>{let r,n=0;return t.pipeThrough(new TransformStream({transform(o,a){if(a.enqueue(o),r){n+=r.byteLength;let c=e===0?0:n/e;c>=1&&(c=1-Number.EPSILON),s?.({percent:c,totalBytes:Math.max(e,n),transferredBytes:n},r)}r=o},flush(){r&&(n+=r.byteLength,s?.({percent:1,totalBytes:Math.max(e,n),transferredBytes:n},r))}}))},se=(t,e)=>{if(!t.body)return t;if(t.status===204)return new Response(null,{status:t.status,statusText:t.statusText,headers:t.headers});const s=Math.max(0,Number(t.headers.get("content-length"))||0);return new Response(U(t.body,s,e),{status:t.status,statusText:t.statusText,headers:t.headers})},re=(t,e,s)=>{if(!t.body)return t;const r=te(s??t.body);return new Request(t,{duplex:"half",body:U(t.body,r,e)})},u=t=>t!==null&&typeof t=="object",y=(...t)=>{for(const e of t)if((!u(e)||Array.isArray(e))&&e!==void 0)throw new TypeError("The `options` argument must be an object");return S({},...t)},L=(t={},e={})=>{const s=new globalThis.Headers(t),r=e instanceof globalThis.Headers,n=new globalThis.Headers(e);for(const[o,a]of n.entries())r&&a==="undefined"||a===void 0?s.delete(o):s.set(o,a);return s};function m(t,e,s){return Object.hasOwn(e,s)&&e[s]===void 0?[]:S(t[s]??[],e[s]??[])}const C=(t={},e={})=>({beforeRequest:m(t,e,"beforeRequest"),beforeRetry:m(t,e,"beforeRetry"),afterResponse:m(t,e,"afterResponse"),beforeError:m(t,e,"beforeError")}),ne=(t,e)=>{const s=new URLSearchParams;for(const r of[t,e])if(r!==void 0)if(r instanceof URLSearchParams)for(const[n,o]of r.entries())s.append(n,o);else if(Array.isArray(r))for(const n of r){if(!Array.isArray(n)||n.length!==2)throw new TypeError("Array search parameters must be provided in [[key, value], ...] format");s.append(String(n[0]),String(n[1]))}else if(u(r))for(const[n,o]of Object.entries(r))o!==void 0&&s.append(n,String(o));else{const n=new URLSearchParams(r);for(const[o,a]of n.entries())s.append(o,a)}return s},S=(...t)=>{let e={},s={},r={},n;const o=[];for(const a of t)if(Array.isArray(a))Array.isArray(e)||(e=[]),e=[...e,...a];else if(u(a)){for(let[c,i]of Object.entries(a)){if(c==="signal"&&i instanceof globalThis.AbortSignal){o.push(i);continue}if(c==="context"){if(i!=null&&(!u(i)||Array.isArray(i)))throw new TypeError("The `context` option must be an object");e={...e,context:i==null?{}:{...e.context,...i}};continue}if(c==="searchParams"){i==null?n=void 0:n=n===void 0?i:ne(n,i);continue}u(i)&&c in e&&(i=S(e[c],i)),e={...e,[c]:i}}u(a.hooks)&&(r=C(r,a.hooks),e.hooks=r),u(a.headers)&&(s=L(s,a.headers),e.headers=s)}return n!==void 0&&(e.searchParams=n),o.length>0&&(o.length===1?e.signal=o[0]:j?e.signal=AbortSignal.any(o):e.signal=o.at(-1)),e.context===void 0&&(e.context={}),e},oe=t=>v.includes(t)?t.toUpperCase():t,ae=["get","put","head","delete","options","trace"],ie=[408,413,429,500,502,503,504],ce=[413,429,503],x={limit:2,methods:ae,statusCodes:ie,afterStatusCodes:ce,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:t=>.3*2**(t-1)*1e3,jitter:void 0,retryOnTimeout:!1},le=(t={})=>{if(typeof t=="number")return{...x,limit:t};if(t.methods&&!Array.isArray(t.methods))throw new Error("retry.methods must be an array");if(t.statusCodes&&!Array.isArray(t.statusCodes))throw new Error("retry.statusCodes must be an array");return{...x,...t}};class T extends Error{request;constructor(e){super(`Request timed out: ${e.method} ${e.url}`),this.name="TimeoutError",this.request=e}}async function ue(t,e,s,r){return new Promise((n,o)=>{const a=setTimeout(()=>{s&&s.abort(),o(new T(t))},r.timeout);r.fetch(t,e).then(n).catch(o).then(()=>{clearTimeout(a)})})}async function he(t,{signal:e}){return new Promise((s,r)=>{e&&(e.throwIfAborted(),e.addEventListener("abort",n,{once:!0}));function n(){clearTimeout(o),r(e.reason)}const o=setTimeout(()=>{e?.removeEventListener("abort",n),s()},t)})}const fe=(t,e)=>{const s={};for(const r in e)Object.hasOwn(e,r)&&!(r in ee)&&!(r in Q)&&(!(r in t)||r in Z)&&(s[r]=e[r]);return s},de=t=>t===void 0?!1:Array.isArray(t)?t.length>0:t instanceof URLSearchParams?t.size>0:typeof t=="object"?Object.keys(t).length>0:typeof t=="string"?t.trim().length>0:!!t;function pe(t){return t instanceof b||t?.name===b.name}function ye(t){return t instanceof T||t?.name===T.name}class p{static create(e,s){const r=new p(e,s),n=async()=>{if(typeof r.#e.timeout=="number"&&r.#e.timeout>w)throw new RangeError(`The \`timeout\` option cannot be greater than ${w}`);await Promise.resolve();let a=await r.#y();for(const c of r.#e.hooks.afterResponse){const i=r.#u(a.clone()),l=await c(r.request,r.#i(),i,{retryCount:r.#s});if(l instanceof globalThis.Response&&(a=l),l instanceof O)throw await Promise.all([i.body?.cancel(),a.body?.cancel()]),new g(l.options)}if(r.#u(a),!a.ok&&(typeof r.#e.throwHttpErrors=="function"?r.#e.throwHttpErrors(a.status):r.#e.throwHttpErrors)){let c=new b(a,r.request,r.#i());for(const i of r.#e.hooks.beforeError)c=await i(c,{retryCount:r.#s});throw c}if(r.#e.onDownloadProgress){if(typeof r.#e.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!W)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return se(a.clone(),r.#e.onDownloadProgress)}return a},o=r.#h(n).finally(async()=>{const a=r.#o,c=[];a&&!a.bodyUsed&&c.push(a.body?.cancel()),r.request.bodyUsed||c.push(r.request.body?.cancel()),await Promise.all(c)});for(const[a,c]of Object.entries(K))a==="bytes"&&typeof globalThis.Response?.prototype?.bytes!="function"||(o[a]=async()=>{r.request.headers.set("accept",r.request.headers.get("accept")||c);const i=await o;if(a==="json"){if(i.status===204)return"";const l=await i.text();return l===""?"":s.parseJson?s.parseJson(l):JSON.parse(l)}return i[a]()});return o}static#d(e){return e&&typeof e=="object"&&!Array.isArray(e)&&!(e instanceof URLSearchParams)?Object.fromEntries(Object.entries(e).filter(([,s])=>s!==void 0)):e}request;#r;#s=0;#t;#e;#o;#n;#a;constructor(e,s={}){if(this.#t=e,this.#e={...s,headers:L(this.#t.headers,s.headers),hooks:C({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:oe(s.method??this.#t.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:le(s.retry),throwHttpErrors:s.throwHttpErrors??!0,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis),context:s.context??{}},typeof this.#t!="string"&&!(this.#t instanceof URL||this.#t instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this.#e.prefixUrl&&typeof this.#t=="string"){if(this.#t.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this.#e.prefixUrl.endsWith("/")||(this.#e.prefixUrl+="/"),this.#t=this.#e.prefixUrl+this.#t}V&&j&&(this.#n=this.#e.signal??this.#t.signal,this.#r=new globalThis.AbortController,this.#e.signal=this.#n?AbortSignal.any([this.#n,this.#r.signal]):this.#r.signal),q&&(this.#e.duplex="half"),this.#e.json!==void 0&&(this.#e.body=this.#e.stringifyJson?.(this.#e.json)??JSON.stringify(this.#e.json),this.#e.headers.set("content-type",this.#e.headers.get("content-type")??"application/json"));const r=s.headers&&new globalThis.Headers(s.headers).has("content-type");if(this.#t instanceof globalThis.Request&&(Y&&this.#e.body instanceof globalThis.FormData||this.#e.body instanceof URLSearchParams)&&!r&&this.#e.headers.delete("content-type"),this.request=new globalThis.Request(this.#t,this.#e),de(this.#e.searchParams)){const o="?"+(typeof this.#e.searchParams=="string"?this.#e.searchParams.replace(/^\?/,""):new URLSearchParams(p.#d(this.#e.searchParams)).toString()),a=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,o);this.request=new globalThis.Request(a,this.#e)}if(this.#e.onUploadProgress){if(typeof this.#e.onUploadProgress!="function")throw new TypeError("The `onUploadProgress` option must be a function");if(!q)throw new Error("Request streams are not supported in your environment. The `duplex` option for `Request` is not available.");this.request=this.#f(this.request,this.#e.body??void 0)}}#c(){const e=this.#e.retry.delay(this.#s);let s=e;return this.#e.retry.jitter===!0?s=Math.random()*e:typeof this.#e.retry.jitter=="function"&&(s=this.#e.retry.jitter(e),(!Number.isFinite(s)||s<0)&&(s=e)),Math.min(this.#e.retry.backoffLimit,s)}async#p(e){if(this.#s++,this.#s>this.#e.retry.limit)throw e;const s=e instanceof Error?e:new I(e);if(s instanceof g)return s.customDelay??this.#c();if(!this.#e.retry.methods.includes(this.request.method.toLowerCase()))throw e;if(this.#e.retry.shouldRetry!==void 0){const r=await this.#e.retry.shouldRetry({error:s,retryCount:this.#s});if(r===!1)throw e;if(r===!0)return this.#c()}if(ye(e)&&!this.#e.retry.retryOnTimeout)throw e;if(pe(e)){if(!this.#e.retry.statusCodes.includes(e.response.status))throw e;const r=e.response.headers.get("Retry-After")??e.response.headers.get("RateLimit-Reset")??e.response.headers.get("X-RateLimit-Retry-After")??e.response.headers.get("X-RateLimit-Reset")??e.response.headers.get("X-Rate-Limit-Reset");if(r&&this.#e.retry.afterStatusCodes.includes(e.response.status)){let n=Number(r)*1e3;Number.isNaN(n)?n=Date.parse(r)-Date.now():n>=Date.parse("2024-01-01")&&(n-=Date.now());const o=this.#e.retry.maxRetryAfter??n;return n<o?n:o}if(e.response.status===413)throw e}return this.#c()}#u(e){return this.#e.parseJson&&(e.json=async()=>this.#e.parseJson(await e.text())),e}async#h(e){try{return await e()}catch(s){const r=Math.min(await this.#p(s),w);if(this.#s<1)throw s;if(await he(r,this.#n?{signal:this.#n}:{}),s instanceof g&&s.customRequest){const n=this.#e.signal?new globalThis.Request(s.customRequest,{signal:this.#e.signal}):new globalThis.Request(s.customRequest);this.#l(n)}for(const n of this.#e.hooks.beforeRetry){const o=await n({request:this.request,options:this.#i(),error:s,retryCount:this.#s});if(o instanceof globalThis.Request){this.#l(o);break}if(o instanceof globalThis.Response)return o;if(o===N)return}return this.#h(e)}}async#y(){this.#r?.signal.aborted&&(this.#r=new globalThis.AbortController,this.#e.signal=this.#n?AbortSignal.any([this.#n,this.#r.signal]):this.#r.signal,this.request=new globalThis.Request(this.request,{signal:this.#e.signal}));for(const s of this.#e.hooks.beforeRequest){const r=await s(this.request,this.#i(),{retryCount:this.#s});if(r instanceof Response)return r;if(r instanceof globalThis.Request){this.#l(r);break}}const e=fe(this.request,this.#e);return this.#o=this.request,this.request=this.#o.clone(),this.#e.timeout===!1?this.#e.fetch(this.#o,e):ue(this.#o,e,this.#r,this.#e)}#i(){if(!this.#a){const{hooks:e,...s}=this.#e;this.#a=Object.freeze(s)}return this.#a}#l(e){this.#a=void 0,this.request=this.#f(e)}#f(e,s){return!this.#e.onUploadProgress||!e.body?e:re(e,this.#e.onUploadProgress,s??this.#e.body??void 0)}}/*! MIT License Â© Sindre Sorhus */const R=t=>{const e=(s,r)=>p.create(s,y(t,r));for(const s of v)e[s]=(r,n)=>p.create(r,y(t,n,{method:s}));return e.create=s=>R(y(s)),e.extend=s=>(typeof s=="function"&&(s=s(t??{})),R(y(t,s))),e.stop=N,e.retry=G,e},f=R(),me="https://cloudflare-worker-token-service.audio-pwa.workers.dev/token",ge="516028107316-04vdmkmjl6k67t26of3r5o9eqdcuefoa.apps.googleusercontent.com",we="https://oauth2.googleapis.com/token",_="audiogata",$="playlists.json",F="plugins.json",D="nowplaying.json",h="https://www.googleapis.com",M="application/vnd.google-apps.folder",A="application/json; charset=UTF-8",H=t=>{application.postUiMessage(t)},d=f.create({hooks:{beforeRequest:[t=>{const e=localStorage.getItem("access_token");return e&&t.headers&&t.headers.set("Authorization","Bearer "+e),t}],afterResponse:[async(t,e,s)=>{if(s.status===401){const r=await be();if(r)return t.headers.set("Authorization","Bearer "+r),d(t,e)}return s}]}}),z=(t,e)=>{localStorage.setItem("access_token",t),e&&localStorage.setItem("refresh_token",e)},be=async()=>{const t=localStorage.getItem("refresh_token");if(!t)return;const e=localStorage.getItem("clientId"),s=localStorage.getItem("clientSecret");let r=me;const n=new URLSearchParams;n.append("client_id",e||ge),n.append("refresh_token",t),n.append("grant_type","refresh_token"),e&&s&&(n.append("client_secret",s),r=we);const o=await f.post(r,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}).json();if(o.access_token)return z(o.access_token,o.refresh_token),o.access_token},Te=async()=>{const e=document.location.host.split(".");e.shift();const s=e.join("."),r=`${document.location.protocol}//${s}`,n=await application.getPluginId(),o=localStorage.getItem("clientId")??"",a=localStorage.getItem("clientSecret")??"";H({type:"info",origin:r,pluginId:n,clientId:o,clientSecret:a})};application.onUiMessage=async t=>{switch(t.type){case"check-login":const e=localStorage.getItem("access_token");e&&H({type:"login",accessToken:e}),await Te();break;case"login":z(t.accessToken,t.refreshToken);break;case"logout":localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token");break;case"save-nowplaying":await ke();break;case"load-nowplaying":await Se();break;case"save-playlists":await Ee(),application.createNotification({message:"Playlists Saved!"});break;case"load-playlists":await Pe(),application.createNotification({message:"Playlists Loaded!"});break;case"save-plugins":await qe(),application.createNotification({message:"Plugins Saved!"});break;case"install-plugins":xe();break;case"set-keys":localStorage.setItem("clientId",t.clientId),localStorage.setItem("clientSecret",t.clientSecret),application.createNotification({message:"Api keys Saved!"});break}};const k=async()=>{const t=`mimeType = '${M}' and title = '${_}'`,e=await f.get(`${h}/drive/v2/files?q=${encodeURIComponent(t)}`).json();return e.items.length>0?e.items[0].id:""},E=async t=>{const e=await B(t);return e?await f.get(`${h}/drive/v2/files/${e}?alt=media`).json():void 0},B=async t=>{const e=await k();if(!e)return;const s=`'${e}' in parents and title = '${t}'`,r=await f.get(`${h}/drive/v2/files?q=${encodeURIComponent(s)}`).json();return r.items.length>0?r.items[0].id:""},Re=async()=>{await f.post(h+"/drive/v2/files",{json:{title:_,mimeType:M}})},P=async(t,e)=>{let s=await k();s||(await Re(),s=await k());const r=await B(t);if(r){const o=(await d.put(h+`/upload/drive/v2/files/${r}?uploadType=resumable`,{json:{mimeType:A}})).headers.get("location");if(!o)throw new Error("Location not found");await d.put(o,{body:JSON.stringify(e)})}else{const o=(await d.post(h+"/upload/drive/v2/files?uploadType=resumable",{json:{title:t,parents:[{id:s}],mimeType:A}})).headers.get("location");if(!o)throw new Error("Location not found");await d.post(o,{body:JSON.stringify(e)})}},ke=async()=>{const t=await application.getNowPlayingTracks();await P(D,t)},Se=async()=>{const t=await E(D);t&&await application.setNowPlayingTracks(t)},Ee=async()=>{const t=await application.getPlaylists();await P($,t)},Pe=async()=>{const t=await E($);t&&await application.addPlaylists(t)},qe=async()=>{const t=await application.getPlugins();await P(F,t)},xe=async()=>{const t=await E(F);t&&await application.installPlugins(t)};application.onDeepLinkMessage=async t=>{application.postUiMessage({type:"deeplink",url:t})};const J=t=>{localStorage.setItem("kb-color-mode",t)};application.onChangeTheme=async t=>{J(t)};const Ae=async()=>{const t=await application.getTheme();J(t)};Ae();
