class k extends Error{response;request;options;constructor(e,s,o){const n=e.status||e.status===0?e.status:"",r=e.statusText||"",a=`${n} ${r}`.trim(),i=a?`status code ${a}`:"an unknown error";super(`Request failed with ${i}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=e,this.request=s,this.options=o}}class I extends Error{request;constructor(e){super(`Request timed out: ${e.method} ${e.url}`),this.name="TimeoutError",this.request=e}}const S=(()=>{let t=!1,e=!1;const s=typeof globalThis.ReadableStream=="function",o=typeof globalThis.Request=="function";if(s&&o)try{e=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type")}catch(n){if(n instanceof Error&&n.message==="unsupported BodyInit type")return!1;throw n}return t&&!e})(),M=typeof globalThis.AbortController=="function",H=typeof globalThis.ReadableStream=="function",D=typeof globalThis.FormData=="function",v=["get","post","put","patch","head","delete"],J={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},g=2147483647,z=new TextEncoder().encode("------WebKitFormBoundaryaxpyiPgbbPti10Rw").length,x=Symbol("stop"),V={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,onUploadProgress:!0,fetch:!0},K={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},Y=t=>{if(!t)return 0;if(t instanceof FormData){let e=0;for(const[s,o]of t)e+=z,e+=new TextEncoder().encode(`Content-Disposition: form-data; name="${s}"`).length,e+=typeof o=="string"?new TextEncoder().encode(o).length:o.size;return e}if(t instanceof Blob)return t.size;if(t instanceof ArrayBuffer)return t.byteLength;if(typeof t=="string")return new TextEncoder().encode(t).length;if(t instanceof URLSearchParams)return new TextEncoder().encode(t.toString()).length;if("byteLength"in t)return t.byteLength;if(typeof t=="object"&&t!==null)try{const e=JSON.stringify(t);return new TextEncoder().encode(e).length}catch{return 0}return 0},W=(t,e)=>{const s=Number(t.headers.get("content-length"))||0;let o=0;return t.status===204?(e&&e({percent:1,totalBytes:s,transferredBytes:o},new Uint8Array),new Response(null,{status:t.status,statusText:t.statusText,headers:t.headers})):new Response(new ReadableStream({async start(n){const r=t.body.getReader();e&&e({percent:0,transferredBytes:0,totalBytes:s},new Uint8Array);async function a(){const{done:i,value:c}=await r.read();if(i){n.close();return}if(e){o+=c.byteLength;const l=s===0?0:o/s;e({percent:l,transferredBytes:o,totalBytes:s},c)}n.enqueue(c),await a()}await a()}}),{status:t.status,statusText:t.statusText,headers:t.headers})},X=(t,e)=>{const s=Y(t.body);let o=0;return new Request(t,{duplex:"half",body:new ReadableStream({async start(n){const r=t.body instanceof ReadableStream?t.body.getReader():new Response("").body.getReader();async function a(){const{done:i,value:c}=await r.read();if(i){e&&e({percent:1,transferredBytes:o,totalBytes:Math.max(s,o)},new Uint8Array),n.close();return}o+=c.byteLength;let l=s===0?0:o/s;(s<o||l===1)&&(l=.99),e&&e({percent:Number(l.toFixed(2)),transferredBytes:o,totalBytes:s},c),n.enqueue(c),await a()}await a()}})})},h=t=>t!==null&&typeof t=="object",d=(...t)=>{for(const e of t)if((!h(e)||Array.isArray(e))&&e!==void 0)throw new TypeError("The `options` argument must be an object");return b({},...t)},P=(t={},e={})=>{const s=new globalThis.Headers(t),o=e instanceof globalThis.Headers,n=new globalThis.Headers(e);for(const[r,a]of n.entries())o&&a==="undefined"||a===void 0?s.delete(r):s.set(r,a);return s};function y(t,e,s){return Object.hasOwn(e,s)&&e[s]===void 0?[]:b(t[s]??[],e[s]??[])}const C=(t={},e={})=>({beforeRequest:y(t,e,"beforeRequest"),beforeRetry:y(t,e,"beforeRetry"),afterResponse:y(t,e,"afterResponse"),beforeError:y(t,e,"beforeError")}),b=(...t)=>{let e={},s={},o={};for(const n of t)if(Array.isArray(n))Array.isArray(e)||(e=[]),e=[...e,...n];else if(h(n)){for(let[r,a]of Object.entries(n))h(a)&&r in e&&(a=b(e[r],a)),e={...e,[r]:a};h(n.hooks)&&(o=C(o,n.hooks),e.hooks=o),h(n.headers)&&(s=P(s,n.headers),e.headers=s)}return e},G=t=>v.includes(t)?t.toUpperCase():t,Q=["get","put","head","delete","options","trace"],Z=[408,413,429,500,502,503,504],tt=[413,429,503],q={limit:2,methods:Q,statusCodes:Z,afterStatusCodes:tt,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:t=>.3*2**(t-1)*1e3},et=(t={})=>{if(typeof t=="number")return{...q,limit:t};if(t.methods&&!Array.isArray(t.methods))throw new Error("retry.methods must be an array");if(t.statusCodes&&!Array.isArray(t.statusCodes))throw new Error("retry.statusCodes must be an array");return{...q,...t}};async function st(t,e,s,o){return new Promise((n,r)=>{const a=setTimeout(()=>{s&&s.abort(),r(new I(t))},o.timeout);o.fetch(t,e).then(n).catch(r).then(()=>{clearTimeout(a)})})}async function ot(t,{signal:e}){return new Promise((s,o)=>{e&&(e.throwIfAborted(),e.addEventListener("abort",n,{once:!0}));function n(){clearTimeout(r),o(e.reason)}const r=setTimeout(()=>{e?.removeEventListener("abort",n),s()},t)})}const nt=(t,e)=>{const s={};for(const o in e)!(o in K)&&!(o in V)&&!(o in t)&&(s[o]=e[o]);return s};class m{static create(e,s){const o=new m(e,s),n=async()=>{if(typeof o._options.timeout=="number"&&o._options.timeout>g)throw new RangeError(`The \`timeout\` option cannot be greater than ${g}`);await Promise.resolve();let i=await o._fetch();for(const c of o._options.hooks.afterResponse){const l=await c(o.request,o._options,o._decorateResponse(i.clone()));l instanceof globalThis.Response&&(i=l)}if(o._decorateResponse(i),!i.ok&&o._options.throwHttpErrors){let c=new k(i,o.request,o._options);for(const l of o._options.hooks.beforeError)c=await l(c);throw c}if(o.request.bodyUsed||await o.request.body?.cancel(),o._options.onDownloadProgress){if(typeof o._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!H)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return W(i.clone(),o._options.onDownloadProgress)}return i},a=o._options.retry.methods.includes(o.request.method.toLowerCase())?o._retry(n):n();for(const[i,c]of Object.entries(J))a[i]=async()=>{o.request.headers.set("accept",o.request.headers.get("accept")||c);const l=await a;if(i==="json"){if(l.status===204||(await l.clone().arrayBuffer()).byteLength===0)return"";if(s.parseJson)return s.parseJson(await l.text())}return l[i]()};return a}request;abortController;_retryCount=0;_input;_options;constructor(e,s={}){if(this._input=e,this._options={...s,headers:P(this._input.headers,s.headers),hooks:C({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:G(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:et(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(M){const o=this._options.signal??this._input.signal;this.abortController=new globalThis.AbortController,this._options.signal=o?AbortSignal.any([o,this.abortController.signal]):this.abortController.signal}if(S&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const n="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),r=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,n);(D&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(r,{...this.request}),this._options)}if(this._options.onUploadProgress){if(typeof this._options.onUploadProgress!="function")throw new TypeError("The `onUploadProgress` option must be a function");if(!S)throw new Error("Request streams are not supported in your environment. The `duplex` option for `Request` is not available.");this.request.body&&(this.request=X(this.request,this._options.onUploadProgress))}}_calculateRetryDelay(e){if(this._retryCount++,this._retryCount>this._options.retry.limit||e instanceof I)throw e;if(e instanceof k){if(!this._options.retry.statusCodes.includes(e.response.status))throw e;const o=e.response.headers.get("Retry-After")??e.response.headers.get("RateLimit-Reset")??e.response.headers.get("X-RateLimit-Reset")??e.response.headers.get("X-Rate-Limit-Reset");if(o&&this._options.retry.afterStatusCodes.includes(e.response.status)){let n=Number(o)*1e3;Number.isNaN(n)?n=Date.parse(o)-Date.now():n>=Date.parse("2024-01-01")&&(n-=Date.now());const r=this._options.retry.maxRetryAfter??n;return n<r?n:r}if(e.response.status===413)throw e}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(s){const o=Math.min(this._calculateRetryDelay(s),g);if(this._retryCount<1)throw s;await ot(o,{signal:this._options.signal});for(const n of this._options.hooks.beforeRetry)if(await n({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===x)return;return this._retry(e)}}async _fetch(){for(const o of this._options.hooks.beforeRequest){const n=await o(this.request,this._options);if(n instanceof Request){this.request=n;break}if(n instanceof Response)return n}const e=nt(this.request,this._options),s=this.request;return this.request=s.clone(),this._options.timeout===!1?this._options.fetch(s,e):st(s,e,this.abortController,this._options)}}/*! MIT License © Sindre Sorhus */const w=t=>{const e=(s,o)=>m.create(s,d(t,o));for(const s of v)e[s]=(o,n)=>m.create(o,d(t,n,{method:s}));return e.create=s=>w(d(s)),e.extend=s=>(typeof s=="function"&&(s=s(t??{})),w(d(t,s))),e.stop=x,e},p=w(),rt="https://cloudflare-worker-token-service.audio-pwa.workers.dev/token",at="516028107316-04vdmkmjl6k67t26of3r5o9eqdcuefoa.apps.googleusercontent.com",it="https://oauth2.googleapis.com/token",N="audiogata",A="playlists.json",U="plugins.json",j="nowplaying.json",u="https://www.googleapis.com",L="application/vnd.google-apps.folder",E="application/json; charset=UTF-8",$=t=>{application.postUiMessage(t)},f=p.create({hooks:{beforeRequest:[t=>{const e=localStorage.getItem("access_token");return e&&t.headers&&t.headers.set("Authorization","Bearer "+e),t}],afterResponse:[async(t,e,s)=>{if(s.status===401){const o=await ct();if(o)return t.headers.set("Authorization","Bearer "+o),f(t,e)}return s}]}}),O=(t,e)=>{localStorage.setItem("access_token",t),e&&localStorage.setItem("refresh_token",e)},ct=async()=>{const t=localStorage.getItem("refresh_token");if(!t)return;const e=localStorage.getItem("clientId"),s=localStorage.getItem("clientSecret");let o=rt;const n=new URLSearchParams;n.append("client_id",e||at),n.append("refresh_token",t),n.append("grant_type","refresh_token"),e&&s&&(n.append("client_secret",s),o=it);const r=await p.post(o,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}).json();if(r.access_token)return O(r.access_token,r.refresh_token),r.access_token},lt=async()=>{const e=document.location.host.split(".");e.shift();const s=e.join("."),o=`${document.location.protocol}//${s}`,n=await application.getPluginId(),r=localStorage.getItem("clientId")??"",a=localStorage.getItem("clientSecret")??"";$({type:"info",origin:o,pluginId:n,clientId:r,clientSecret:a})};application.onUiMessage=async t=>{switch(t.type){case"check-login":const e=localStorage.getItem("access_token");e&&$({type:"login",accessToken:e}),await lt();break;case"login":O(t.accessToken,t.refreshToken);break;case"logout":localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token");break;case"save-nowplaying":await pt();break;case"load-nowplaying":await ht();break;case"save-playlists":await ft(),application.createNotification({message:"Playlists Saved!"});break;case"load-playlists":await dt(),application.createNotification({message:"Playlists Loaded!"});break;case"save-plugins":await yt(),application.createNotification({message:"Plugins Saved!"});break;case"install-plugins":mt();break;case"set-keys":localStorage.setItem("clientId",t.clientId),localStorage.setItem("clientSecret",t.clientSecret),application.createNotification({message:"Api keys Saved!"});break}};const _=async()=>{const t=`mimeType = '${L}' and title = '${N}'`,e=await p.get(`${u}/drive/v2/files?q=${encodeURIComponent(t)}`).json();return e.items.length>0?e.items[0].id:""},R=async t=>{const e=await B(t);return e?await p.get(`${u}/drive/v2/files/${e}?alt=media`).json():void 0},B=async t=>{const e=await _();if(!e)return;const s=`'${e}' in parents and title = '${t}'`,o=await p.get(`${u}/drive/v2/files?q=${encodeURIComponent(s)}`).json();return o.items.length>0?o.items[0].id:""},ut=async()=>{await p.post(u+"/drive/v2/files",{json:{title:N,mimeType:L}})},T=async(t,e)=>{let s=await _();s||(await ut(),s=await _());const o=await B(t);if(o){const r=(await f.put(u+`/upload/drive/v2/files/${o}?uploadType=resumable`,{json:{mimeType:E}})).headers.get("location");if(!r)throw new Error("Location not found");await f.put(r,{body:JSON.stringify(e)})}else{const r=(await f.post(u+"/upload/drive/v2/files?uploadType=resumable",{json:{title:t,parents:[{id:s}],mimeType:E}})).headers.get("location");if(!r)throw new Error("Location not found");await f.post(r,{body:JSON.stringify(e)})}},pt=async()=>{const t=await application.getNowPlayingTracks();await T(j,t)},ht=async()=>{const t=await R(j);t&&await application.setNowPlayingTracks(t)},ft=async()=>{const t=await application.getPlaylists();await T(A,t)},dt=async()=>{const t=await R(A);t&&await application.addPlaylists(t)},yt=async()=>{const t=await application.getPlugins();await T(U,t)},mt=async()=>{const t=await R(U);t&&await application.installPlugins(t)};application.onDeepLinkMessage=async t=>{application.postUiMessage({type:"deeplink",url:t})};const F=t=>{localStorage.setItem("kb-color-mode",t)};application.onChangeTheme=async t=>{F(t)};const gt=async()=>{const t=await application.getTheme();F(t)};gt();
